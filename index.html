import React, { useEffect, useState } from 'react';

/*
  Asteroid Impact Game - React version
  Turns the simulator into a simple educational web game.

  Mechanics:
  - Player picks an asteroid from real NASA data or random values.
  - Player chooses mitigation strategy (deflect, fragment, evacuate).
  - Simulation runs and scores the player based on casualties prevented.
  - Encourages replay with different strategies.

  Requirements:
  - Tailwind CSS setup
  - NASA API key (or DEMO_KEY)
*/

function kineticEnergyJ(diameter_m, density_kgm3, velocity_ms) {
  const radius = diameter_m / 2;
  const volume = (4 / 3) * Math.PI * Math.pow(radius, 3);
  const mass = volume * density_kgm3;
  return 0.5 * mass * Math.pow(velocity_ms, 2);
}

function joulesToMegatons(joules) {
  return joules / 4.184e15;
}

function blastRadiusMeters(energyJ) {
  const k = 60;
  return k * Math.pow(energyJ / 1e12, 1 / 3);
}

function estimateCasualties(blastRadius_m, popDensity) {
  const area_km2 = Math.PI * Math.pow(blastRadius_m / 1000, 2);
  return Math.round(area_km2 * popDensity * 0.02);
}

export default function ImpactGame() {
  const NASA_KEY = process.env.REACT_APP_NASA_API_KEY || 'DEMO_KEY';
  const [neos, setNeos] = useState([]);
  const [asteroid, setAsteroid] = useState(null);
  const [results, setResults] = useState(null);
  const [strategy, setStrategy] = useState(null);
  const [score, setScore] = useState(null);

  useEffect(() => {
    async function fetchNeos() {
      try {
        const today = new Date();
        const yyyy = today.getUTCFullYear();
        const mm = String(today.getUTCMonth() + 1).padStart(2, '0');
        const dd = String(today.getUTCDate()).padStart(2, '0');
        const startDate = `${yyyy}-${mm}-${dd}`;
        const end = new Date();
        end.setDate(today.getDate() + 2);
        const emm = String(end.getUTCMonth() + 1).padStart(2, '0');
        const edd = String(end.getUTCDate()).padStart(2, '0');
        const endDate = `${end.getUTCFullYear()}-${emm}-${edd}`;

        const url = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${startDate}&end_date=${endDate}&api_key=${NASA_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        const objects = [];
        if (data && data.near_earth_objects) {
          Object.values(data.near_earth_objects).forEach((arr) => {
            arr.forEach((o) => objects.push(o));
          });
        }
        setNeos(objects.slice(0, 20));
      } catch (e) {
        console.error(e);
      }
    }
    fetchNeos();
  }, []);

  function simulateImpact(ast, strat) {
    const d = Math.round(ast.estimated_diameter?.meters?.estimated_diameter_max || 50);
    const v = Math.round(ast.close_approach_data?.[0]?.relative_velocity?.kilometers_per_second || 20) * 1000;
    const density = 3000;
    const popDensity = 1000;
    const energy = kineticEnergyJ(d, density, v);
    const megatons = joulesToMegatons(energy);
    const blastR = blastRadiusMeters(energy);
    const casualties = estimateCasualties(blastR, popDensity);

    let prevented = 0;
    if (strat === 'deflect') prevented = casualties * 0.7;
    if (strat === 'fragment') prevented = casualties * 0.5;
    if (strat === 'evacuate') prevented = casualties * 0.4;

    setResults({ d, v, megatons, blastR, casualties, prevented });
    setScore(Math.max(0, Math.round(prevented / (casualties + 1) * 100)));
  }

  return (
    <div className="p-4 max-w-4xl mx-auto">
      <h1 className="text-2xl font-bold mb-2">ğŸŒ Asteroid Defense Game</h1>
      <p className="mb-4 text-sm opacity-80">Choose an asteroid, pick a defense strategy, and see how well you save Earth!</p>

      {!asteroid && (
        <div className="grid grid-cols-2 gap-2">
          {neos.map((neo) => (
            <button key={neo.id} onClick={() => setAsteroid(neo)} className="border p-2 rounded hover:bg-white/10">
              <div className="font-medium text-sm">{neo.name}</div>
              <div className="text-xs opacity-70">Ã˜ {Math.round(neo.estimated_diameter?.meters?.estimated_diameter_max || 0)} m</div>
            </button>
          ))}
        </div>
      )}

      {asteroid && !results && (
        <div className="mt-4">
          <h2 className="font-semibold mb-2">Asteroid Selected: {asteroid.name}</h2>
          <p className="text-sm mb-2">Pick your strategy:</p>
          <div className="flex gap-2">
            <button onClick={() => { setStrategy('deflect'); simulateImpact(asteroid, 'deflect'); }} className="px-3 py-1 bg-indigo-600 rounded">ğŸš€ Deflect</button>
            <button onClick={() => { setStrategy('fragment'); simulateImpact(asteroid, 'fragment'); }} className="px-3 py-1 bg-red-600 rounded">ğŸ’¥ Fragment</button>
            <button onClick={() => { setStrategy('evacuate'); simulateImpact(asteroid, 'evacuate'); }} className="px-3 py-1 bg-yellow-500 rounded">ğŸƒ Evacuate</button>
          </div>
        </div>
      )}

      {results && (
        <div className="mt-4 p-3 border rounded bg-white/5">
          <h2 className="font-semibold mb-2">Results</h2>
          <div className="text-sm space-y-1">
            <div>Energy: {results.megatons.toFixed(2)} megatons TNT</div>
            <div>Blast radius: {Math.round(results.blastR)} m</div>
            <div>Casualties (if no action): {results.casualties.toLocaleString()}</div>
            <div>Casualties prevented with {strategy}: {results.prevented.toLocaleString()}</div>
            <div className="font-bold">Score: {score}% Earth saved!</div>
          </div>
          <button onClick={() => { setAsteroid(null); setResults(null); setStrategy(null); setScore(null); }} className="mt-3 px-3 py-1 border rounded">Play again</button>
        </div>
      )}
    </div>
  );
}
